// functions/api/proxy.jsexport async function onRequest(context) {  const { request } = context;  const url = new URL(request.url);  const targetUrl = url.searchParams.get('url');  if (request.method === 'OPTIONS') return handleOptions(request);  if (!targetUrl) return new Response('Missing URL', { status: 400 });  const isPlaylist = targetUrl.includes('.m3u8');  const cache = caches.default;  const cacheKey = new Request(request.url, request);  // 1. Only check cache for segments, NEVER for playlists  if (!isPlaylist) {    let cachedResponse = await cache.match(cacheKey);    if (cachedResponse) {      const hitResponse = new Response(cachedResponse.body, cachedResponse);      hitResponse.headers.set('X-Proxy-Cache', 'HIT');      return hitResponse;    }  }  try {    const proxyRequest = new Request(targetUrl, {      method: 'GET',      headers: filterHeaders(request.headers),      redirect: 'follow',    });    const response = await fetch(proxyRequest);    const contentType = response.headers.get('content-type') || '';    let newResponse;    // 2. Handle M3U8 Rewriting (The Playlist)    if (isPlaylist || contentType.includes('mpegurl')) {      let text = await response.text();      const targetBaseUrl = targetUrl.substring(0, targetUrl.lastIndexOf('/') + 1);      const proxyBaseUrl = `${url.origin}${url.pathname}?url=`;      const lines = text.split('\n').map(line => {        const trimmed = line.trim();        if (trimmed === '' || trimmed.startsWith('#')) return line;                // Ensure absolute URL conversion for segments        const absoluteUrl = trimmed.startsWith('http')           ? trimmed           : new URL(trimmed, targetBaseUrl).href;                return `${proxyBaseUrl}${encodeURIComponent(absoluteUrl)}`;      });      newResponse = new Response(lines.join('\n'), {        headers: {          'Content-Type': 'application/vnd.apple.mpegurl',          // CRITICAL: Prevent the browser/CDN from caching the live playlist          'Cache-Control': 'no-store, no-cache, must-revalidate, max-age=0',          'Pragma': 'no-cache',          'Expires': '0',          'Access-Control-Allow-Origin': '*',        }      });    }     // 3. Handle Video Segments (.ts, .m4s, etc.)    else {      newResponse = new Response(response.body, {        status: response.status,        headers: filterResponseHeaders(response.headers),      });      // Cache segments for 1 hour to save bandwidth/latency      newResponse.headers.set('Cache-Control', 'public, max-age=3600');            // Save segments to Cloudflare Edge Cache      context.waitUntil(cache.put(cacheKey, newResponse.clone()));    }    addCorsHeaders(newResponse.headers);    newResponse.headers.set('X-Proxy-Cache', 'MISS');    return newResponse;  } catch (error) {    return new Response(`Proxy Error: ${error.message}`, { status: 500 });  }}// --- Helper Functions ---function filterHeaders(headers) {  const h = new Headers();  // Standardize UA to prevent 403 Forbidden errors from some providers  h.set('User-Agent', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36');  if (headers.has('range')) h.set('range', headers.get('range'));  return h;}function filterResponseHeaders(headers) {  const h = new Headers();  const keep = ['content-type', 'content-length', 'accept-ranges', 'content-encoding'];  for (const [key, value] of headers.entries()) {    if (keep.includes(key.toLowerCase())) h.set(key, value);  }  return h;}function handleOptions(request) {  return new Response(null, {    status: 204,    headers: {      'Access-Control-Allow-Origin': '*',      'Access-Control-Allow-Methods': 'GET, OPTIONS',      'Access-Control-Allow-Headers': '*',      'Access-Control-Max-Age': '86400',    }  });}function addCorsHeaders(headers) {  headers.set('Access-Control-Allow-Origin', '*');  headers.set('Access-Control-Expose-Headers', '*');}