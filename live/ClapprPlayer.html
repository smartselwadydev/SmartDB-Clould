<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <style>
      html, body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        border: 0;
        overflow: hidden;
        background-color: #000;
      }
      #player {
        width: 100%;
        height: 100%;
        background-color: #000;
      }
      .ios-play-button {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 18px;
        border-radius: 5px;
        cursor: pointer;
        z-index: 1000;
        display: none;
      }
    </style>
    <script src="js/clappr.min.js"></script>
    <!-- Optional: Add Level Selector plugin for HLS quality selection -->
    <script src="https://cdn.jsdelivr.net/npm/clappr-level-selector-plugin@latest/dist/level-selector.min.js"></script>
  </head>
<body>
    <div id="player"></div>
    <button id="iosPlayButton" class="ios-play-button">Tap to Play</button>
    
    <script>
      var params = {};
      window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(str, key, value) {
        params[key] = value;
      });
      
      var url = params["ch"];
      
      // Check if iOS
      function isIOS() {
        return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      }
      
      // Initialize player
      function initPlayer() {
        var player = new Clappr.Player({
          source: url,
          maxBufferLength: 30,
          poster: 'live2.jpg',
          mute: false,
          width: '100%',
          height: '100%',
          playback: {
            playInline: true,
            controls: true,
            crossOrigin: 'anonymous',
            // Add HLS.js for better iOS compatibility
            hlsjsConfig: {
              enableWorker: true,
              lowLatencyMode: true,
              backBufferLength: 90
            }
          },
          plugins: {
            playback: [LevelSelector],
            core: []
          },
          parentId: '#player',
          autoPlay: !isIOS(), // Don't autoplay on iOS
          mediacontrol: {seekbar: "#E113D3", buttons: "#66B2FF"},
          height: '100%',
          width: '100%',
          // Add these for better iOS compatibility
          clapprSetting: {
            'alwaysControlControls': true,
            'chromeless': false,
            'allowUserInteraction': true
          }
        });
        
        // Store player instance globally for iOS play button
        window.clapprPlayer = player;
        
        // For iOS, show play button
        if (isIOS()) {
          document.getElementById('iosPlayButton').style.display = 'block';
          
          // Listen for play events
          player.on(Clappr.Events.PLAYER_PLAY, function() {
            document.getElementById('iosPlayButton').style.display = 'none';
          });
          
          // Handle playback errors
          player.on(Clappr.Events.PLAYER_ERROR, function(error) {
            console.log('Playback error:', error);
            // Try to recover
            player.play();
          });
        }
        
        return player;
      }
      
      // iOS play button handler
      document.getElementById('iosPlayButton').addEventListener('click', function() {
        if (window.clapprPlayer) {
          // iOS requires a user gesture to unmute and play video
          window.clapprPlayer.play();
          window.clapprPlayer.setVolume(100);
          this.style.display = 'none';
        }
      });
      
      // Initialize player when page loads
      document.addEventListener('DOMContentLoaded', function() {
        initPlayer();
      });
      
      // Additional iOS fix: Handle page visibility changes
      document.addEventListener('visibilitychange', function() {
        if (!document.hidden && window.clapprPlayer) {
          // Try to resume playback when page becomes visible again
          setTimeout(function() {
            window.clapprPlayer.play();
          }, 300);
        }
      });
      
      // Handle page resume on iOS
      document.addEventListener('resume', function() {
        if (window.clapprPlayer) {
          setTimeout(function() {
            window.clapprPlayer.play();
          }, 300);
        }
      }, false);
    </script>
</body>
</html>